<section class="container-big">
  @if (!loadingBook) {
  <div class="flex gap-10">
    <div class="max-w-96 flex-shrink-0">
      <div class="max-h-[500px] h-full">
        <img
          [src]="
            mainCover
              ? (mainCover | bookImage : 'L' : 'id')
              : '/assets/if there is no image.png'
          "
          alt="main cover"
          class="w-full h-full object-cover"
        />
      </div>
      <div class="my-5">
        <p *ngIf="book.first_publish_date" class="mb-2">
          First published in
          <span class="font-semibold">{{ book.first_publish_date }}</span>
        </p>
        <p *ngIf="bookExternalData.number_of_pages_median" class="mb-2">
          Pages:
          <span class="font-semibold">{{
            bookExternalData.number_of_pages_median
          }}</span>
        </p>
        <p *ngIf="book.created">
          Release date:
          <span class="font-semibold">{{
            book.created.value | date : "longDate"
          }}</span>
        </p>
      </div>
      <div class="mb-3" *ngIf="book.links">
        <h3 class="text-2xl font-semibold">Links</h3>
        <ul class="list-disc pl-5">
          @for (link of book.links; track $index) {
          <li
            class="mb-2 underline text-blue-700 transition-colors hover:text-blue-800"
          >
            <a [href]="link.url">{{ link.title }}</a>
          </li>
          }
        </ul>
      </div>
    </div>
    <div>
      <h1 class="font-semibold text-5xl mb-5">
        {{ book.title | truncateText : 100 }}
      </h1>
      <div class="mb-5" *ngIf="book.description; else noDescription">
        <h3 class="text-2xl font-semibold pb-2">Description</h3>
        <p>
          {{
            book.description.value || book.description.toString()
              | truncateText : descriptionShowLength : isDescriptionFullText
          }}
          <span class="ml-1"
            ><button
              type="button"
              (click)="showCloseDescription()"
              class="underline text-blue-700 transition-colors hover:text-blue-800"
            >
              {{ descriptionBtn }}
            </button></span
          >
        </p>
      </div>
      <ng-template #noDescription
        ><p class="my-5">This book has no description</p></ng-template
      >
      <div class="flex justify-between pb-10">
        <div class="mb-3 max-w-[30%] w-full">
          <app-item-scroll-list
            [itemObj]="charactersListObject"
            [listTitle]="'Main Characters'"
          ></app-item-scroll-list>
        </div>
        <div class="mb-3 max-w-[30%] w-full">
          <app-item-scroll-list
            [itemObj]="placesListObject"
            [listTitle]="'Main Places'"
          ></app-item-scroll-list>
        </div>
        <div class="mb-3 max-w-[30%] w-full">
          <app-item-scroll-list
            [itemObj]="subjectsListObject"
            [listTitle]="'Main Subjects'"
          ></app-item-scroll-list>
        </div>
      </div>
      @if (!loadingAuthor) {
      <div class="mb-3">
        <h3 class="text-2xl font-semibold pb-2">Authors</h3>
        @for (author of authors; track $index) {
        <div class="flex w-full gap-5 mb-10">
          <div class="max-w-52 w-full h-72 flex-shrink-0">
            <img
              [src]="
                author.photos
                  ? (author.photos[0].toString() | authorImage : 'L' : 'id')
                  : '/assets/if there is no image.png'
              "
              alt=""
              class="w-full h-full object-cover"
            />
          </div>
          <div>
            <h5 class="text-xl font-semibold pb-2">{{ author.name }}</h5>
            <p *ngIf="isString(author.bio); else noBio">
              {{ author.bio | truncateText : 350 }}
            </p>
            <ng-template #noBio>
              <p>
                This author is waiting that someone will write for him or her a
                normal bio info XD
              </p>
            </ng-template>
            <a
              class="inline-block mt-5 underline text-blue-700 transition-colors hover:text-blue-800"
              [routerLink]="['/authorlist', authorKeys[$index]]"
              >Go to Author page</a
            >
          </div>
        </div>
        }
      </div>
      } @else {
      <p class="text-3xl font-semibold">Loading authors...</p>
      }
    </div>
  </div>
  <div class="flex justify-between items-start py-10">
    <div class="mb-3 w-60">
      <h3 class="text-2xl font-semibold pb-2">Ratings</h3>
      <p class="rating__item">
        Currently reading:
        <span class="rating__value">{{
          bookExternalData.currently_reading_count || 0
        }}</span>
      </p>
      <p class="rating__item">
        Already read:
        <span class="rating__value">{{
          bookExternalData.already_read_count || 0
        }}</span>
      </p>
      <p class="rating__item">
        Want to reading:
        <span class="rating__value">{{
          bookExternalData.want_to_read_count || 0
        }}</span>
      </p>
      <p class="rating__item">
        Average ratings:
        <span class="rating__value">{{
          bookExternalData.ratings_average | number : "1.1-2" || 0
        }}</span>
      </p>
      <p class="rating__item">
        Ratings count:
        <span class="rating__value">{{
          bookExternalData.ratings_count || 0
        }}</span>
      </p>
      <p class="rating__item">
        1 star:
        <span class="rating__value">{{
          bookExternalData.ratings_count_1 || 0
        }}</span>
      </p>
      <p class="rating__item">
        2 star:
        <span class="rating__value">{{
          bookExternalData.ratings_count_2 || 0
        }}</span>
      </p>
      <p class="rating__item">
        3 star:
        <span class="rating__value">{{
          bookExternalData.ratings_count_3 || 0
        }}</span>
      </p>
      <p class="rating__item">
        4 star:
        <span class="rating__value">{{
          bookExternalData.ratings_count_4 || 0
        }}</span>
      </p>
      <p class="rating__item">
        5 star:
        <span class="rating__value">{{
          bookExternalData.ratings_count_5 || 0
        }}</span>
      </p>
    </div>
    <div class="max-w-full w-full mx-5">
      <form [formGroup]="commentForm" (ngSubmit)="onCommentFormSubmit()">
        <label for="comment" class="block mb-2 text-2xl font-semibold"
          >Your review</label
        >
        <textarea
          name="comment"
          id="comment"
          rows="6"
          class="block p-2.5 w-full text-base resize-none text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
          [placeholder]="
            !commentForm.controls.comment.disabled
              ? 'Write your review here...'
              : 'You have already written a review'
          "
          formControlName="comment"
          [class.textarea-error]="commentForm.controls.comment.touched && commentForm.controls.comment.errors?.['required']"
          [class.disabled-textarea]="commentForm.controls.comment.disabled"
        ></textarea>
        <div
          class="validate-error mt-2"
          *ngIf="commentForm.controls.comment.touched && commentForm.controls.comment.errors?.['required']"
        >
          You should write a comment
        </div>
        <div class="flex gap-5 items-center my-5">
          <label for="rating" class="text-xl font-semibold">Your rating</label>
          <star-rating-control
            id="rating"
            formControlName="rating"
            [staticColor]="'default'"
            [readOnly]="commentForm.controls.comment.disabled"
          ></star-rating-control>
        </div>
        <div class="validate-error mt-2" *ngIf="!isRatingSet">
          You should choose a rating
        </div>
        <app-button
          [button-styles]="'width: 100%;'"
          [text]="commentFormBtn"
          [disabled]="commentForm.controls.comment.errors?.['required'] || commentForm.controls.comment.disabled"
        />
      </form>
      <div class="pt-10">
        <div
          class="mb-5"
          *ngIf="
            commentPostedResult || commentEditedResult || commentDeletedResult
          "
        >
          <p
            class="text-red-600"
            [class.successfull]="
              commentPostedResult?.isSuccessfull ||
              commentEditedResult?.isSuccessfull ||
              commentDeletedResult?.isSuccessfull
            "
          >
            {{
              commentPostedResult?.message ||
                commentEditedResult?.message ||
                commentDeletedResult?.message
            }}
          </p>
        </div>
        @if(userComment) {
        <h3 class="text-2xl font-semibold pb-2">Your Review</h3>
        <div
          class="bg-white max-w-full rounded-2xl px-6 py-4 mb-10 shadow-lg hover:shadow-2xl transition duration-500"
        >
          <div class="mt-4">
            <div class="flex justify-between">
              <h1
                class="text-lg text-gray-700 font-semibold hover:underline cursor-pointer"
              >
                Book Review
              </h1>
              <div>
                <button
                  class="mr-4 text-gray-600 transition-colors hover:underline hover:text-gray-800"
                  (click)="editComment(userComment.id)"
                >
                  Edit comment
                </button>
                <button
                  class="text-gray-600 transition-colors hover:text-gray-800 hover:underline"
                  (click)="deleteComment(userComment.id)"
                >
                  Delete comment
                </button>
              </div>
            </div>
            <div class="flex mt-2">
              <star-rating
                [starType]="'svg'"
                [rating]="userComment.rating"
                [staticColor]="'default'"
                [readOnly]="true"
              ></star-rating>
            </div>
            <p class="mt-4 text-md text-gray-600">
              {{ userComment.comment }}
            </p>
            <div class="flex justify-between items-center">
              <div class="mt-4 flex items-center space-x-4 py-6">
                <div class="">
                  <img
                    class="w-24 h-24 rounded-full object-cover"
                    [src]="userComment.photoURL"
                    alt=""
                  />
                </div>
                <div class="text-sm font-semibold">
                  {{ userComment.email }} •
                  <span class="font-normal">
                    {{ userComment.date | date : "medium" }}</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
        } @else {
        <p class="mb-10">You have not written a review yet</p>
        } @if (comments.length) {
        <h3 class="text-2xl font-semibold pb-2">All reviews</h3>
        @for (comment of comments; track $index) {

        <div
          class="bg-white max-w-full rounded-2xl px-6 py-4 mb-10 shadow-lg hover:shadow-2xl transition duration-500"
        >
          <div class="mt-4">
            <div class="flex justify-between">
              <h1
                class="text-lg text-gray-700 font-semibold hover:underline cursor-pointer"
              >
                Book Review
              </h1>
              <div *ngIf="comment.email === neededUserInfo.email">
                <button
                  class="mr-4 text-gray-600 transition-colors hover:underline hover:text-gray-800"
                  (click)="editComment(comment.id)"
                >
                  Edit comment
                </button>
                <button
                  class="text-gray-600 transition-colors hover:text-gray-800 hover:underline"
                  (click)="deleteComment(comment.id)"
                >
                  Delete comment
                </button>
              </div>
            </div>
            <div class="flex mt-2">
              <star-rating
                [starType]="'svg'"
                [rating]="comment.rating"
                [staticColor]="'default'"
                [readOnly]="true"
              ></star-rating>
            </div>
            <p class="mt-4 text-md text-gray-600">
              {{ comment.comment }}
            </p>
            <div class="flex justify-between items-center">
              <div class="mt-4 flex items-center space-x-4 py-6">
                <div class="">
                  <img
                    class="w-24 h-24 rounded-full object-cover"
                    [src]="comment.photoURL"
                    alt=""
                  />
                </div>
                <div class="text-sm font-semibold">
                  {{ comment.email }} •
                  <span class="font-normal">
                    {{ comment.date | date : "medium" }}</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
        } } @else {
        <p>Write a first opinion on the book!</p>
        }
      </div>
    </div>
    <div class="w-60">
      <h3 class="text-2xl font-semibold pb-2 text-center">Bookmark</h3>
      <p class="mb-5 text-center">
        {{ isBookmarked ? "Bookmarked" : "Not bookmarked" }}
      </p>
      <app-bookmark-button
        [isBookmarked]="isBookmarked"
        (bookmarkedChange)="getBookmarkedChange($event)"
        class="text-center max-w-full w-full block"
      ></app-bookmark-button>
    </div>
  </div>
  } @else {
  <p class="text-3xl font-semibold">Loading...</p>
  }
</section>
